name: Build and Deploy FRONTEND

env:
  PROJECT_NAME: my-app
  PROJECT_TYPE: frontend
  WORKING_DIRECTORY: .
  DEV_APP_PORT:
  DEV_DOMAIN_NAME: my-app.avrean.net
  PROD_APP_PORT:
  PROD_DOMAIN_NAME: my-app.thistlddoesnotexist
  ENABLE_CACHE: false
  ENABLE_CACHE_CONTROL: false
  ENABLE_RATE_LIMITING: false
  DEV_FRONTEND_ENV: ${{ secrets.DEV_FRONTEND_ENV }}
  PROD_FRONTEND_ENV: ${{ secrets.PROD_FRONTEND_ENV }}
  DEV_SERVER_IP: ${{ secrets.DEV_SERVER_HZN_HOSTNAME }}
  DEV_SERVER_USER: ${{ secrets.DEV_SERVER_HZN_USER }}
  PROD_SERVER_IP: ${{ secrets.PROD_SERVER_IP }}
  PROD_SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  DEV_SERVER_PASSWORD: ${{ secrets.DEV_SERVER_HZN_PASSWORD }}
  PROD_SERVER_PASSWORD: ${{ secrets.PROD_SERVER_PASSWORD }}

on:
  push:
    branches:
      - '*'
  workflow_dispatch: {}

jobs:
  #build:
  #  timeout-minutes: 15
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Checkout code
  #      uses: actions/checkout@v4

  #    - name: Setup Node.js
  #      uses: actions/setup-node@v4
  #      with:
  #        node-version-file: '.nvmrc'

  #    - name: Setup pnpm
  #      uses: pnpm/action-setup@v4
  #      with:
  #        version: 9

  #    - name: Get pnpm store directory
  #      shell: bash
  #      run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

  #    - name: Cache pnpm dependencies
  #      uses: actions/cache@v4
  #      with:
  #        path: ${{ env.STORE_PATH }}
  #        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
  #        restore-keys: |
  #          ${{ runner.os }}-pnpm-store-

  #    - name: Create .env file
  #      working-directory: ${{ env.WORKING_DIRECTORY }}
  #      run: |
  #        if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
  #          echo "${{ secrets.DEV_FRONTEND_ENV }}" > .env
  #        else
  #          echo "${{ secrets.PROD_FRONTEND_ENV }}" > .env
  #        fi

  #    - name: Install dependencies
  #      working-directory: ${{ env.WORKING_DIRECTORY }}
  #      run: pnpm install --frozen-lockfile

  #    - name: Lint
  #      working-directory: ${{ env.WORKING_DIRECTORY }}
  #      run: pnpm eslint .

  #    - name: Build
  #      working-directory: ${{ env.WORKING_DIRECTORY }}
  #      run: pnpm run build

  #    - name: Prepare standalone package
  #      working-directory: ${{ env.WORKING_DIRECTORY }}
  #      run: |
  #        cp -r public .next/standalone/
  #        cp -r .next/static .next/standalone/.next/
  #        mv .next/standalone/.next .next/standalone/_next

  #    - name: Upload build artifacts
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: standalone-build
  #        path: ${{ env.WORKING_DIRECTORY }}/.next/standalone
  #        retention-days: 1

  #deploy:
  #  timeout-minutes: 10
  #  needs: [build]
  #  runs-on: ubuntu-latest
  #  if: (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main') && success()
  #  steps:
  #    - name: Set environment variables for Dev
  #      if: github.ref == 'refs/heads/dev'
  #      run: |
  #        echo "SERVER_USER=${{ env.DEV_SERVER_USER }}" >> $GITHUB_ENV
  #        echo "SERVER_IP=${{ env.DEV_SERVER_IP }}" >> $GITHUB_ENV
  #        echo "SERVER_PASSWORD=${{ env.DEV_SERVER_PASSWORD }}" >> $GITHUB_ENV
  #        echo "ENVIRONMENT=dev" >> $GITHUB_ENV
  #        echo "APP_PORT=${{ env.DEV_APP_PORT }}" >> $GITHUB_ENV
  #        echo "DOMAIN_NAME=${{ env.DEV_DOMAIN_NAME }}" >> $GITHUB_ENV

  #    - name: Set environment variables for Prod
  #      if: github.ref != 'refs/heads/dev'
  #      run: |
  #        echo "SERVER_USER=${{ env.PROD_SERVER_USER }}" >> $GITHUB_ENV
  #        echo "SERVER_IP=${{ env.PROD_SERVER_IP }}" >> $GITHUB_ENV
  #        echo "SERVER_PASSWORD=${{ env.PROD_SERVER_PASSWORD }}" >> $GITHUB_ENV
  #        echo "ENVIRONMENT=prod" >> $GITHUB_ENV
  #        echo "APP_PORT=${{ env.PROD_APP_PORT }}" >> $GITHUB_ENV
  #        echo "DOMAIN_NAME=${{ env.PROD_DOMAIN_NAME }}" >> $GITHUB_ENV

  #    - name: Download build artifacts
  #      uses: actions/download-artifact@v4
  #      with:
  #        name: standalone-build
  #        path: standalone

  #    - name: SSH - Prepare Server
  #      uses: appleboy/ssh-action@v1.0.0
  #      with:
  #        timeout: 60s
  #        host: ${{ env.SERVER_IP }}
  #        username: ${{ env.SERVER_USER }}
  #        key: ${{ env.SSH_KEY }}
  #        port: 2223
  #        script: |
  #          SITE_PATH="/home/${{ env.SERVER_USER }}/sites/${{ env.PROJECT_NAME }}/${{ env.ENVIRONMENT }}"
  #          if [ "${{ env.WORKING_DIRECTORY }}" != "." ]; then
  #            SITE_PATH="$SITE_PATH/${{ env.WORKING_DIRECTORY }}"
  #          fi
  #          rm -rf "$SITE_PATH"
  #          mkdir -p "$SITE_PATH"

  #    - name: SCP - Transfer standalone build
  #      uses: appleboy/scp-action@v0.1.4
  #      with:
  #        host: ${{ env.SERVER_IP }}
  #        username: ${{ env.SERVER_USER }}
  #        key: ${{ env.SSH_KEY }}
  #        port: 2223
  #        source: standalone/*
  #        target: /home/${{ env.SERVER_USER }}/sites/${{ env.PROJECT_NAME }}/${{ env.ENVIRONMENT }}
  #        strip_components: 1

  #    - name: SSH - Deploy
  #      uses: appleboy/ssh-action@v1.0.0
  #      with:
  #        timeout: 60s
  #        host: ${{ env.SERVER_IP }}
  #        username: ${{ env.SERVER_USER }}
  #        key: ${{ env.SSH_KEY }}
  #        port: 2223
  #        script: |
  #          SITE_PATH="/home/${{ env.SERVER_USER }}/sites/${{ env.PROJECT_NAME }}/${{ env.ENVIRONMENT }}"
  #          if [ "${{ env.WORKING_DIRECTORY }}" != "." ]; then
  #            SITE_PATH="$SITE_PATH/${{ env.WORKING_DIRECTORY }}"
  #          fi
  #          cd "$SITE_PATH"

  #          # Rinomina _next in .next (era stato rinominato per evitare problemi con hidden files)
  #          if [ -d "_next" ]; then
  #            mv _next .next
  #          fi

  #          # Inizializza nvm
  #          export NVM_DIR="$HOME/.nvm"
  #          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

  #          # Stop old process
  #          pm2 delete ${{ env.PROJECT_NAME }}_${{ env.ENVIRONMENT }}_${{ env.PROJECT_TYPE }} || true

  #          # Start standalone server
  #          NODE_ENV=production PORT=${{ env.APP_PORT }} pm2 start server.js \
  #            --name "${{ env.PROJECT_NAME }}_${{ env.ENVIRONMENT }}_${{ env.PROJECT_TYPE }}" \
  #            --max-memory-restart 4G \
  #            --update-env

  #          # Configure nginx
  #          if [ "${{ env.ENVIRONMENT }}" = "dev" ]; then
  #            ansible-playbook /home/${{ env.SERVER_USER }}/ansible/start_nginx_conf.ansible.yml \
  #              -e "ansible_become_pass=${{ env.SERVER_PASSWORD }} env_type=${{ env.ENVIRONMENT }} project_name=${{ env.PROJECT_NAME }} project_type=${{ env.PROJECT_TYPE }} app_port=${{ env.APP_PORT }} working_directory=${{ env.WORKING_DIRECTORY }} server_name=${{ env.DOMAIN_NAME }} enable_rate_limiting=${{env.ENABLE_RATE_LIMITING}} rate_burst=${{env.RATE_BURST}} enable_cache=${{env.ENABLE_CACHE}} enable_cache_control=${{env.ENABLE_CACHE_CONTROL}}"
  #          else
  #            ansible-playbook /home/${{ env.SERVER_USER }}/ansible/set_nginx_conf.ansible.yml \
  #              -e "ansible_become_pass=${{ env.SERVER_PASSWORD }} env_type=${{ env.ENVIRONMENT }} project_name=${{ env.PROJECT_NAME }} project_type=${{ env.PROJECT_TYPE }} app_port=${{ env.APP_PORT }} working_directory=${{ env.WORKING_DIRECTORY }} server_name=${{ env.DOMAIN_NAME }} enable_rate_limiting=${{env.ENABLE_RATE_LIMITING}} rate_burst=${{env.RATE_BURST}} enable_cache=${{env.ENABLE_CACHE}} enable_cache_control=${{env.ENABLE_CACHE_CONTROL}}"
  #          fi
